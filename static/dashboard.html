<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: white;
            padding: 20px;
            padding-bottom: 90px;
        }
        .header { margin-bottom: 30px; }
        h1 { font-size: 32px; margin-bottom: 10px; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #1e293b;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #334155;
        }
        .stat-label { color: #94a3b8; font-size: 14px; margin-bottom: 10px; }
        .stat-value { font-size: 36px; font-weight: bold; }
        .stat-change { color: #10b981; font-size: 14px; margin-top: 10px; }
        
        .vacancies-section {
            background: #1e293b;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #334155;
            margin-bottom: 30px;
        }
        .section-title { font-size: 20px; margin-bottom: 20px; }
        
        .vacancy-item {
            background: #0f172a;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .vacancy-item:hover { background: #1e293b; }
        .vacancy-title { font-weight: 600; margin-bottom: 5px; }
        .vacancy-stats { color: #94a3b8; font-size: 14px; }
        
        .empty { text-align: center; color: #64748b; padding: 40px; }
        
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #1e293b;
            border-top: 1px solid #334155;
            display: flex;
            justify-content: space-around;
            padding: 10px 15px 20px 15px;
            z-index: 1000;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #64748b; text-decoration: none; font-size: 12px; width: 25%;
        }
        .nav-item.active { color: #3b82f6; }
        .nav-icon { font-size: 24px; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä –î–∞—à–±–æ—Ä–¥</h1>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏</div>
            <div class="stat-value" id="statVacancies">...</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">–í—Å–µ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</div>
            <div class="stat-value" id="statCandidates">...</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">–ü–æ–¥—Ö–æ–¥—è—Ç</div>
            <div class="stat-value" id="statSuitable">...</div>
        </div>
    </div>

    <div class="vacancies-section">
        <div class="section-title">–í–∞—à–∏ –≤–∞–∫–∞–Ω—Å–∏–∏</div>
        <div id="vacanciesList">
            <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="/dashboard" class="nav-item active">
            <div class="nav-icon">üìä</div>
            –î–∞—à–±–æ—Ä–¥
        </a>
        <a href="/vacancies" class="nav-item">
            <div class="nav-icon">üìã</div>
            –í–∞–∫–∞–Ω—Å–∏–∏
        </a>
        <a href="/upload" class="nav-item">
            <div class="nav-icon">üìÑ</div>
            –ê–Ω–∞–ª–∏–∑
        </a>
        <a href="/settings" class="nav-item">
            <div class="nav-icon">‚öôÔ∏è</div>
            –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </a>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const userId = tg.initDataUnsafe?.user?.id || 'test_user_123';

        async function loadDashboard() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const statsRes = await fetch(`/api/dashboard/stats/${userId}`);
                const stats = await statsRes.json();
                
                document.getElementById('statVacancies').textContent = stats.vacancies || 0;
                document.getElementById('statCandidates').textContent = stats.candidates || 0;
                document.getElementById('statSuitable').textContent = stats.suitable || 0;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π
                const vacRes = await fetch(`/api/vacancies/list/${userId}`);
                const vacancies = await vacRes.json();
                
                const list = document.getElementById('vacanciesList');
                
                if (vacancies.length === 0) {
                    list.innerHTML = '<div class="empty">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π<br><a href="/vacancies" style="color: #3b82f6;">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –≤–∞–∫–∞–Ω—Å–∏—é</a></div>';
                    return;
                }
                
                // –î–ª—è –∫–∞–∂–¥–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏ —Å—á–∏—Ç–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                const items = await Promise.all(vacancies.map(async (v) => {
                    try {
                        const candRes = await fetch(`/api/candidates/list/${userId}/${v.id}`);
                        const candidates = await candRes.json();
                        
                        const suitable = candidates.filter(c => {
                            try {
                                const analysis = typeof c.analysis_result === 'string' 
                                    ? JSON.parse(c.analysis_result) 
                                    : c.analysis_result;
                                return analysis?.verdict === '–ü–æ–¥—Ö–æ–¥–∏—Ç';
                            } catch { return false; }
                        }).length;
                        
                        return `
                            <div class="vacancy-item" onclick="location.href='/vacancy-detail?id=${v.id}'">
                                <div class="vacancy-title">${v.title}</div>
                                <div class="vacancy-stats">
                                    üë• ${candidates.length} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ‚Ä¢ 
                                    ‚úÖ ${suitable} –ø–æ–¥—Ö–æ–¥–∏—Ç
                                </div>
                            </div>
                        `;
                    } catch {
                        return `
                            <div class="vacancy-item">
                                <div class="vacancy-title">${v.title}</div>
                                <div class="vacancy-stats">üë• 0 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</div>
                            </div>
                        `;
                    }
                }));
                
                list.innerHTML = items.join('');
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞:', e);
                document.getElementById('vacanciesList').innerHTML = 
                    '<div class="empty" style="color: #ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
            }
        }

        loadDashboard();
    </script>
</body>
</html>