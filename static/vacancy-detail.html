<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–µ—Ç–∞–ª–∏ –≤–∞–∫–∞–Ω—Å–∏–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: white;
            padding: 20px;
            padding-bottom: 90px;
        }
        .header {
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .back-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }
        h1 { font-size: 24px; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-box {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #334155;
        }
        .stat-value { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 13px; color: #94a3b8; }
        
        .section {
            background: #1e293b;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }
        .section-title { 
            font-size: 18px; 
            font-weight: 600; 
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .candidate-card {
            background: #0f172a;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #64748b;
        }
        .candidate-card.suitable { border-left-color: #10b981; }
        .candidate-card.unsuitable { border-left-color: #ef4444; }
        
        .candidate-name { 
            font-weight: 600; 
            margin-bottom: 5px;
            font-size: 16px;
        }
        .candidate-verdict { 
            font-size: 14px; 
            margin-bottom: 8px;
        }
        .candidate-verdict.suitable { color: #10b981; }
        .candidate-verdict.unsuitable { color: #ef4444; }
        
        .candidate-reason { 
            color: #94a3b8; 
            font-size: 13px;
            margin-bottom: 8px;
        }
        .candidate-matches {
            color: #64748b;
            font-size: 12px;
        }
        
        .empty { 
            text-align: center; 
            color: #64748b; 
            padding: 30px;
            font-size: 14px;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #1e293b;
            border-top: 1px solid #334155;
            display: flex;
            justify-content: space-around;
            padding: 10px 15px 20px 15px;
            z-index: 1000;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            color: #64748b; text-decoration: none; font-size: 12px; width: 25%;
        }
        .nav-item.active { color: #3b82f6; }
        .nav-icon { font-size: 24px; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="back-btn" onclick="history.back()">‚Üê</div>
        <div>
            <h1 id="vacancyTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-value" id="totalCandidates">0</div>
            <div class="stat-label">–í—Å–µ–≥–æ</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" style="color: #10b981;" id="suitableCandidates">0</div>
            <div class="stat-label">–ü–æ–¥—Ö–æ–¥—è—Ç</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" style="color: #ef4444;" id="unsuitableCandidates">0</div>
            <div class="stat-label">–ù–µ –ø–æ–¥—Ö–æ–¥—è—Ç</div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">‚úÖ –ü–æ–¥—Ö–æ–¥—è—â–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã</div>
        <div id="suitableList">
            <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">‚ùå –ù–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã</div>
        <div id="unsuitableList">
            <div class="empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="/dashboard" class="nav-item">
            <div class="nav-icon">üìä</div>
            –î–∞—à–±–æ—Ä–¥
        </a>
        <a href="/vacancies" class="nav-item">
            <div class="nav-icon">üìã</div>
            –í–∞–∫–∞–Ω—Å–∏–∏
        </a>
        <a href="/upload" class="nav-item">
            <div class="nav-icon">üìÑ</div>
            –ê–Ω–∞–ª–∏–∑
        </a>
        <a href="/settings" class="nav-item">
            <div class="nav-icon">‚öôÔ∏è</div>
            –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </a>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const userId = tg.initDataUnsafe?.user?.id || 'test_user_123';
        
        // –ü–æ–ª—É—á–∞–µ–º ID –≤–∞–∫–∞–Ω—Å–∏–∏ –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const vacancyId = urlParams.get('id');

        async function loadVacancyDetails() {
            if (!vacancyId) {
                alert('ID –≤–∞–∫–∞–Ω—Å–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω');
                history.back();
                return;
            }

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞–∫–∞–Ω—Å–∏—é
                const vacRes = await fetch(`/api/vacancies/${vacancyId}/${userId}`);
                const vacancy = await vacRes.json();
                document.getElementById('vacancyTitle').textContent = vacancy.title;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                const candRes = await fetch(`/api/candidates/list/${userId}/${vacancyId}`);
                const candidates = await candRes.json();

                // –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∏ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏—Ö
                const suitable = [];
                const unsuitable = [];

                candidates.forEach(c => {
                    let analysis = null;
                    try {
                        analysis = typeof c.analysis_result === 'string' 
                            ? JSON.parse(c.analysis_result) 
                            : c.analysis_result;
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∞–Ω–∞–ª–∏–∑–∞:', e);
                    }

                    if (analysis?.verdict === '–ü–æ–¥—Ö–æ–¥–∏—Ç') {
                        suitable.push({ ...c, analysis });
                    } else {
                        unsuitable.push({ ...c, analysis });
                    }
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                document.getElementById('totalCandidates').textContent = candidates.length;
                document.getElementById('suitableCandidates').textContent = suitable.length;
                document.getElementById('unsuitableCandidates').textContent = unsuitable.length;

                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–∫–∏
                renderCandidates('suitableList', suitable, true);
                renderCandidates('unsuitableList', unsuitable, false);

            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        function renderCandidates(containerId, candidates, isSuitable) {
    const container = document.getElementById(containerId);
    
    if (candidates.length === 0) {
        container.innerHTML = '<div class="empty">–ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</div>';
        return;
    }

    container.innerHTML = candidates.map(c => {
        const analysis = c.analysis || {};
        const matchText = analysis.matches_count 
            ? `–°–æ–≤–ø–∞–¥–µ–Ω–∏–π: ${analysis.matches_count} –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤` 
            : '';
        
        const emailButton = isSuitable ? `
            <button 
                onclick="sendEmail('${c.email || ''}', '${c.full_name || ''}')" 
                style="margin-top: 10px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;"
            >
                üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ
            </button>
        ` : '';
        
        return `
            <div class="candidate-card ${isSuitable ? 'suitable' : 'unsuitable'}">
                <div class="candidate-name">${c.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                <div class="candidate-verdict ${isSuitable ? 'suitable' : 'unsuitable'}">
                    ${isSuitable ? '‚úÖ' : '‚ùå'} ${analysis.verdict || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'}
                </div>
                <div class="candidate-reason">${analysis.reason || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                ${matchText ? `<div class="candidate-matches">${matchText}</div>` : ''}
                ${emailButton}
            </div>
        `;
    }).join('');
}

async function sendEmail(email, name) {
    if (!email) {
        alert('–£ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –Ω–µ—Ç email');
        return;
    }
    
    const subject = prompt('–¢–µ–º–∞ –ø–∏—Å—å–º–∞:', `–¢–µ—Å—Ç–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ`);
    if (!subject) return;
    
    const body = prompt('–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞:', 
        `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${name}!\n\n–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –æ—Ç–∫–ª–∏–∫ –Ω–∞ –Ω–∞—à—É –≤–∞–∫–∞–Ω—Å–∏—é.\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\nHR-–∫–æ–º–∞–Ω–¥–∞`
    );
    if (!body) return;
    
    try {
        const res = await fetch('/api/send_email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: userId,
                to_email: email,
                subject: subject,
                body: body
            })
        });
        
        const result = await res.json();
        
        if (result.status === 'success') {
            alert('‚úÖ –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (e) {
        alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message);
    }
}

        loadVacancyDetails();
    </script>
</body>
</html>